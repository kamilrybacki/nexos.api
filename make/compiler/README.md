# Type Stub Compiler Utility

A utility for automatically generating and customizing type stubs for API endpoint controllers using mypy's `stubgen` tool.

## Overview

This utility generates type stubs (`.pyi` files) for Python modules and applies custom transformations to API endpoint controllers. It specifically transforms `Operations` classes into `RequestMaker` classes with proper inheritance and method signatures.

## Why?

When You define new API endpoint controllers, you want to ensure that they are type-checked correctly. 
This utility helps maintain type safety and IDE support by generating stubs that reflect the actual code structure and functionality.

Normally custom operations can be defined in a "pydantic" way (akin to `Config` nested subclass), but when using these operations
thought the `request` accessor (which points to the `RequestMaker` class), the IDE does not recognize them as valid operations.

Stubs generated by this utility **inject** methods from the `Operations` class into the `RequestMaker` class,
ensuring that IDEs like PyCharm can properly recognize and provide autocompletion for these operations.

## Features

- **Automatic stub generation** using `mypy.stubgen` for `src/` and `tests/` directories
- **AST-based rewriting** to transform endpoint controller classes
- **Custom class exclusion** to skip specific controllers from transformation
- **Inline stub placement** alongside source files for better IDE integration

## Usage

### Command Line
```bash
python utils/compiler/run.py
```

### Task Runner
```bash
task install-dev  # Runs stub compilation as part of development setup
```

## How It Works

1. **Generation**: Creates type stubs for all Python files using `mypy.stubgen`
2. **Transformation**: Applies AST transformations to replace `Operations` classes with `RequestMaker` classes
3. **Integration**: Moves generated stubs to sit alongside source files
4. **Cleanup**: Removes temporary stub directory and test-related stub files

## Configuration

The utility can exclude specific classes from transformation:

```python
apply_rewrites_to_stub(stub_file_path, exclude_classes=["NexosAIEndpointController"])
```

## File Structure

- `utils/compiler/run.py` - Main entry point
- `utils/compiler/compile.py` - Stub generation logic
- `utils/compiler/rewrite.py` - AST transformation for endpoint controllers

This ensures proper type checking for API endpoint controllers while maintaining compatibility with the existing codebase architecture.